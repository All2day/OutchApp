//The Risk Game
var game = {
  prototypes:{
    player: {
      team:{
        type:"team"
      },
      armies:{
        type:"list",
        prototype:"army"
      }
    },
    team:{
      color:{
        type:"color"
      },
      players:{
        type:"list",
        prototype:"player"
      },
      territories:{
        type:"list",
        prototype:"territory",
        hooks:{
          change:{
            actions:{
              1:{
                type:"if",
                condition:"count >= 21",
                actions:{
                  1:{
                    type:"changephase",
                    phase:"scoreboard"
                  }
                }
              }
            }
          }
        }
      }
    },
    army:{
      owner:{type:"team"},
      home:{type:"territory"}
    },
    territory:{
      name:{type:"string"},
      continent:{type:"continent"},
      neighbours:{
        type:"list",
        prototype:"territory"
      },
      armies:{
        type:"list",
        prototype:"army"
      },
      owner:{type:"team"},
      army_owners:{
        type:"list",
        prototype:"team"
      },
      next_army_timer:{
        type:"timer",
        hooks:{
          end:{
            actions:{
              1:{
                type:"create",
                prototype:"army",
                target:"territory.armies",
                actions:{
                  1:{
                    type:"set",
                    target:"owner",
                    source:"territory.owner"
                  },
                  2:{
                    type:"reset",
                    target:"timer"
                  },
                  3:{
                    type:"start",
                    target:"timer"
                  }
                }
              }
            }
          }
        }
      },
      next_war_timer:{
        type:"timer",
        hooks:{
          end:{
            vars:{
              looser:{type:"team"}
            },
            actions:{
              1:{
                type:"set",
                target:"hook.looser",
                source:"territory.army_owners.rand"
              },
              2:{
                type:"remove",
                list:"territory.armies",
                target:"territory.armies[owner=hook.looser].first"
              },
              3:{
                type:"if",
                condition:"territory.armies[owner=hook.looser].count = 0",
                actions:{
                  1:{
                    type:"remove",
                    list:"territory.army_owners",
                    source:"hook.looser"
                  },
                  2:{
                    type:"if",
                    condition:"territory.army_owners.count=1",
                    actions:{
                      1:{
                        type:"set",
                        target:"territory.at_war",
                        source:"false"
                      },
                      2:{
                        type:"reset",
                        timer:"timer"
                      },
                      3:{
                        type:"if",
                        condition:"territory.army_owners.first != territory.owner",
                        actions:{
                          1:{
                            type:"remove",
                            list:"territory.owner.territories",
                            source:"territory"
                          },
                          2:{
                            type:"set",
                            target:"territory.owner",
                            source:"territory.army_owners.first"
                          },
                          3:{
                            type:"add",
                            list:"territory.owner.territories",
                            source:"territory"
                          },
                          4:{
                            type:"set",
                            target:"territory.continent.owner",
                            source:null
                          },
                          5:{
                            type:"reset",
                            timer:"territory.continent.next_army_timer",
                          },
                          6:{
                            type:"if",
                            condition:"territory.continent.territories[owner=territory.owner].count = territory.continent.territories.count",
                            actions:{
                              1:{
                                type:"start",
                                timer:"territory.continent.next_army_time"
                              },
                              2:{
                                type:"set",
                                target:"territory.continent.owner",
                                source:"territory.owner"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },//End of next war timer
      at_war:{type:"bool"},
      svg:{type:"vector"},
      boundingbox:{type:"vector"}
    }, //end of territory
    continent:{
      territories:{
        type:"list",
        prototype:"territory"
      },
      name:{type:"string"},
      armies_per_round:{type:"number"},
      next_army_timer:{type:"timer"},
      owner:{type:"team"},
      color:{type:"color"},
      pickup_zone:{type:"pos"}
    }
  },
  vars: {
    name: {
      type:"string"
    },
    center: {
      type: "pos"
    },
    dir:{type:"number"}
  },
  phases:{
    /*create:{
      //goal is to choose a center (and heading) of the game together with a game name

    },
    join:{
      //normal join phase, though there should be exactly two players
    },*/
    play:{
      vars:{
        players: { //The face down cards waiting to be played
          type:"list",
          prototype:"card"
        },
        territories: { //The current stack of cards. The last added is the current card, which the next card must match
          type:"list",
          prototype:"card"
        },
        teams:{
          type:"list",
          prototype:"team"
        },
        continents:{
          type:"list",
          prototype:"continent",
        },
        game_end_timer:{
          type:"timer",
          duration:"10m",
          hooks:{
            end:{
              actions:{
                1:{
                  type:"changephase",
                  phase:"scoreboard"
                }
              }
            }
          }
        },
        init_timer:{
          type:"timer",
          duration:"1m",
          hooks:{
            end:{
              action:{
                1:{
                  type:"set",
                  target:"phase.game_started",
                  source:"true"
                }
              }
            }
          }
        },
        game_started:{type:"bool"}
      },
      views:{
        1:{
          type:"MapView",
          center:"game.center",
          rotation:"game.center.heading",
          geoElements:{
            1:{
              type:"list",
              list:"phase.territories",
              geoElements:{
                1:{
                  type:"vector",
                  stroke:"5px",
                  color:"continent.color",
                  fill:null,
                  hooks:{
                    enter:{
                      actions:{
                        1:{
                          type:"set",
                          target:"element.fill",
                          source:"rgba(255,255,255,0.5)"
                        },
                        2:{
                          type:"vibrate",
                          duration:500 //ms
                        }
                      }
                    },
                    leave:{
                      actions:{
                        1:{
                          type:"set",
                          target:"element.fill",
                          source:null
                        }
                      }
                    },
                    volumeup:{
                      actions:{
                        1:{
                          type:"if",
                          //does the players team has more than one army in that territory?
                          condition:"armies[team=player.team].count > 1",
                          actions:{
                            1:{//add the army to the player
                              type:"add",
                              list:"player.armies",
                              target:"armies[team=player.team].first"
                            },
                            2:{//remove the army from the territory
                              type:"remove",
                              list:"armies",
                              target: "armies[team=player.team].first"
                            }
                          }, // end of if actions
                          else:{
                            1:{
                              type:"vibrate",
                              duration:1000
                            }
                          }
                        }
                      }
                    },//volume up handling
                    volumedown:{
                      actions:{
                        1:{
                          type:"if",
                          //is the game started and the player has at least one army
                          condition:"phase.game_started && player.armies.count > 0",
                          actions:{
                            1:{
                              type:"if",
                              //if the owning team is different from the players team
                              condition:"territory.owner != player.team",
                              actions:{
                                1:{
                                  type:"if",
                                  condition:"territory.neighbours[at_war].count = 0 && territory.neighbours[owner=player.team].count > 0",
                                  actions:{
                                    1:{
                                      type:"add",
                                      list:"territory.armies",
                                      source:"player.armies.first"
                                    },
                                    2:{
                                      type:"remove",
                                      list:"player.armies",
                                      source:"player.armies.first"
                                    },
                                    3:{
                                      type:"if",
                                      condition:"!territory.at_war",
                                      actions:{
                                        1:{
                                          type:"set",
                                          target:"territory.at_war",
                                          source:"true"
                                        },
                                        2:{
                                          type:"start",
                                          timer:"territory.next_war_timer",
                                        }
                                      }
                                    }
                                  }
                                }
                              },//End of owning team check
                              else:{
                                1:{
                                  type:"add",
                                  list:"territory.armies",
                                  source:"player.armies.first"
                                },
                                2:{
                                  type:"remove",
                                  list:"player.armies",
                                  source:"player.armies.first"
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              } //end of territory
            } //end of territory list
          } //end of geo elements
        } //End of map view
      }, // End of views
      hooks:{
        start:{
          actions:{
            1:{
              type:"alert",
              text:"'fisk'"
            }
          }
        }
      }
    },
    scoreboard:{

    }
  }
};
